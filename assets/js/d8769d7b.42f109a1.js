/*! For license information please see d8769d7b.42f109a1.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[896823],{815217:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var o=n(824246),r=n(511151);const i={id:"index",title:"Building Backends",sidebar_label:"Overview",description:"Building backends using the new backend system"},a=void 0,s={unversionedId:"backend-system/building-backends/index",id:"backend-system/building-backends/index",title:"Building Backends",description:"Building backends using the new backend system",source:"@site/../docs/backend-system/building-backends/01-index.md",sourceDirName:"backend-system/building-backends",slug:"/backend-system/building-backends/index",permalink:"/docs/backend-system/building-backends/index",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/backend-system/building-backends/01-index.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"index",title:"Building Backends",sidebar_label:"Overview",description:"Building backends using the new backend system"},sidebar:"docs",previous:{title:"Naming Patterns",permalink:"/docs/backend-system/architecture/naming-patterns"},next:{title:"Migration Guide",permalink:"/docs/backend-system/building-backends/migrating"}},c={},l=[{value:"Customization",id:"customization",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Services",id:"services",level:3},{value:"Custom Service Implementations",id:"custom-service-implementations",level:3},{value:"Split Into Multiple Backends",id:"split-into-multiple-backends",level:2}];function d(e){const t=Object.assign({blockquote:"blockquote",p:"p",strong:"strong",a:"a",h1:"h1",code:"code",pre:"pre",h2:"h2",h3:"h3"},(0,r.ah)(),e.components);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.blockquote,{children:["\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"DISCLAIMER: The new backend system is in alpha, and still under active development. While we have reviewed the interfaces carefully, they may still be iterated on before the stable release."})}),"\n"]}),"\n",(0,o.jsxs)(t.blockquote,{children:["\n",(0,o.jsxs)(t.p,{children:["NOTE: If you have an existing backend that is not yet using the new backend\nsystem, see ",(0,o.jsx)(t.a,{href:"/docs/backend-system/building-backends/migrating",children:"migrating"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["This section covers how to set up and customize your own Backstage backend. It covers some aspects of how backend instances fit into the larger system, but for a more in-depth explanation of the role of backends in the backend system, see ",(0,o.jsx)(t.a,{href:"/docs/backend-system/architecture/backends",children:"the architecture section"}),"."]}),"\n",(0,o.jsx)(t.h1,{id:"overview",children:"Overview"}),"\n",(0,o.jsxs)(t.p,{children:["A minimal Backstage backend is very lightweight. It is a single package with a ",(0,o.jsx)(t.code,{children:"package.json"})," file and a ",(0,o.jsx)(t.code,{children:"src/index.ts"})," file, not counting surrounding tooling and documentation. The package is typically placed within the ",(0,o.jsx)(t.code,{children:"packages/backend"})," folder of a Backstage monorepo, but that is up to you. The backend package is part of any project created with ",(0,o.jsx)(t.code,{children:"@backstage/create-app"}),", so you typically do not need to create it yourself."]}),"\n",(0,o.jsxs)(t.p,{children:["When you create a new project with ",(0,o.jsx)(t.code,{children:"@backstage/create-app"}),", you'll get a backend package with a ",(0,o.jsx)(t.code,{children:"src/index.ts"})," that looks something like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-ts",children:"import { createBackend } from '@backstage/backend-defaults'; // Omitted in the examples below\n\nconst backend = createBackend();\n\nbackend.add(import('@backstage/plugin-app-backend'));\nbackend.add(import('@backstage/plugin-catalog-backend'));\nbackend.add(import('@backstage/plugin-scaffolder-backend'));\nbackend.add(\n  import('@backstage/plugin-catalog-backend-module-scaffolder-entity-model'),\n);\n\nbackend.start();\n"})}),"\n",(0,o.jsx)(t.p,{children:"There will be a couple more plugins and modules in the initial setup, but the overall layout is the same."}),"\n",(0,o.jsxs)(t.p,{children:["What we're doing in this file is creating a new backend using ",(0,o.jsx)(t.code,{children:"createBackend"}),", and then installing a collection of different plugins, modules, and services that we want to be part of that backend. Plugins are standalone features, modules augment existing plugins or modules, while services can be used to override behavior for deeper customizations. Each module can only target a single plugin, and that plugin must also be present in the same backend. Finally, we start up the backend by calling the ",(0,o.jsx)(t.code,{children:"start"})," method."]}),"\n",(0,o.jsx)(t.h2,{id:"customization",children:"Customization"}),"\n",(0,o.jsx)(t.p,{children:"Apart from installing existing plugins and modules in the backend, there are a couple of different ways in which you can customize your backend installation."}),"\n",(0,o.jsx)(t.h3,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsxs)(t.p,{children:["Perhaps the most accessible way is though static configuration, which you can read more about in the documentation for how to ",(0,o.jsx)(t.a,{href:"/docs/conf/writing",children:"write configuration"}),". Many different aspects of the backend can be configured, including both the behavior of the backend itself, as well as many plugins or modules. You'll need to refer to the documentation of each plugin or module to see what configuration is available. Also be sure to check out the documentation of the ",(0,o.jsx)(t.a,{href:"/docs/backend-system/core-services/index",children:"core services"}),", as that also covers how to configure those."]}),"\n",(0,o.jsx)(t.h3,{id:"services",children:"Services"}),"\n",(0,o.jsxs)(t.p,{children:["Speaking of services, they are another important point of customization. Services allow you to make deeper and broader customizations of the backend. They are similar to ",(0,o.jsx)(t.a,{href:"/docs/api/utility-apis",children:"Utility APIs"})," in the frontend system, using dependency injection to make common functionality available to plugins and modules. You can read more about services in the ",(0,o.jsx)(t.a,{href:"/docs/backend-system/architecture/services",children:"architecture section"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["There is a core set of services that must be installed in all backends, for things like logging, database access, serving HTTP, and so on. Luckily, all of these services are installed by default when you use ",(0,o.jsx)(t.code,{children:"createBackend"})," from the ",(0,o.jsx)(t.code,{children:"@backstage/backend-defaults"})," package, which is what you have in a standard setup."]}),"\n",(0,o.jsx)(t.p,{children:"All of these services can be replaced with your own implementations if you need to customize them. The simplest way to do this is to use the existing service implementations but with additional options. Many of the core services can be customized this way, but not all, as they don't all have meaningful options."}),"\n",(0,o.jsx)(t.p,{children:"For example, let's say we want to customize the core configuration service to enable remote configuration loading. That would look something like this:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-ts",children:"import { rootConfigServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  rootConfigServiceFactory({\n    remote: { reloadIntervalSeconds: 60 },\n  }),\n);\n"})}),"\n",(0,o.jsx)(t.p,{children:"This will make it possible to pass URLs as configuration targets, and those URLs will be polled every 60 seconds for changes."}),"\n",(0,o.jsxs)(t.p,{children:["There is one exception to the above, which is the built-in ",(0,o.jsx)(t.code,{children:"PluginMetadataService"})," that is provided by the framework and is not possible to override."]}),"\n",(0,o.jsx)(t.h3,{id:"custom-service-implementations",children:"Custom Service Implementations"}),"\n",(0,o.jsx)(t.p,{children:"When overriding services you are not limited to the existing implementations, you can also provide your own custom service factories. This will let you globally override services with completely custom implementations, or build on existing implementations to add additional logic."}),"\n",(0,o.jsxs)(t.p,{children:["To override a service, you provide it in the ",(0,o.jsx)(t.code,{children:"services"})," option just like above, but this time we need to use ",(0,o.jsx)(t.code,{children:"createServiceFactory"})," to create our factory. For example, if you want to replace the default ",(0,o.jsx)(t.code,{children:"LoggerService"})," with your own, it might look like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-ts",children:"const backend = createBackend();\n\nbackend.add(\n  createServiceFactory({\n    service: coreServices.logger,\n    deps: {\n      rootLogger: coreServices.rootLogger,\n      plugin: coreServices.pluginMetadata,\n      config: coreServices.rootConfig,\n    },\n    factory({ rootLogger, plugin, config }) {\n      const labels = readCustomLogLabelsForPlugin(config, plugin); // custom logic\n      return rootLogger.child(labels);\n    },\n  }),\n);\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"LoggerService"})," is responsible for creating a specialized logger instance for each plugin, while the ",(0,o.jsx)(t.code,{children:"RootLoggerService"})," is the actual logging implementation. The default implementation of ",(0,o.jsx)(t.code,{children:"LoggerService"})," will decorate the logger with a ",(0,o.jsx)(t.code,{children:"plugin"})," label that contains the plugin ID. Here in our custom implementation we read out additional labels from the configuration and add those as well."]}),"\n",(0,o.jsxs)(t.p,{children:["This example touches on the fact that services can have different scopes, being either scoped to individual plugins or the root backend instance. To read more about this, see the ",(0,o.jsx)(t.a,{href:"/docs/backend-system/architecture/services",children:"architecture section"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"split-into-multiple-backends",children:"Split Into Multiple Backends"}),"\n",(0,o.jsxs)(t.blockquote,{children:["\n",(0,o.jsx)(t.p,{children:"NOTE: Splitting into multiple backends is an advanced deployment pattern that requires significant effort and there are not yet many built-in tools in the framework to help you out. Only use this if necessary."}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["A more advanced way to deploy Backstage is to split the backend plugins into multiple different backend deployments. Both the ",(0,o.jsx)(t.a,{href:"/docs/deployment/scaling",children:"deployment documentation"})," and ",(0,o.jsx)(t.a,{href:"/docs/overview/threat-model#trust-model",children:"Threat Model"})," explain the benefits of this, so here we'll focus on how to do it."]}),"\n",(0,o.jsxs)(t.p,{children:["To create a separate backend we need to create an additional backend package. This package will be built and deployed separately from your existing backend. There is currently no template to create a backend via ",(0,o.jsx)(t.code,{children:"yarn new"}),", so the quickest way is to copy the new package and modify. The naming is up to you and it depends on how you are splitting things and up. For this example we'll just use a simple suffix. You might end up with a directory structure like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-text",children:'packages/\n  backend-a/\n    src/\n      index.ts\n    package.json <- "name": "backend-a"\n  backend-b/\n    src/\n      index.ts\n    package.json <- "name": "backend-b"\n'})}),"\n",(0,o.jsxs)(t.p,{children:["You can now trim down the ",(0,o.jsx)(t.code,{children:"src/index.ts"})," files to only include the plugins and modules that you want to be part of that backend. For example, if you want to split out the scaffolder plugin, you might end up with something like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-ts",children:"const backend = createBackend();\n\nbackend.add(import('@backstage/plugin-app-backend'));\nbackend.add(import('@backstage/plugin-catalog-backend'));\nbackend.add(\n  import('@backstage/plugin-catalog-backend-module-scaffolder-entity-model'),\n);\nbackend.start();\n"})}),"\n",(0,o.jsxs)(t.p,{children:["And ",(0,o.jsx)(t.code,{children:"backend-b"}),", don't forget to clean up dependencies in ",(0,o.jsx)(t.code,{children:"package.json"})," as well:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-ts",children:"const backend = createBackend();\n\nbackend.add(import('@backstage/plugin-scaffolder-backend'));\nbackend.start();\n"})}),"\n",(0,o.jsxs)(t.p,{children:["We've now split the backend into two separate deployments, but we still need to make sure that they can communicate with each other. This is the hard and somewhat tedious part, as Backstage currently doesn't provide an out of the box solution that solves this. You'll need to manually configure the two backends with custom implementations of the ",(0,o.jsx)(t.code,{children:"DiscoveryService"})," and have them return the correct URLs for each other. Likewise, you'll also need to provide a custom implementation of the ",(0,o.jsx)(t.code,{children:"DiscoveryApi"})," in the frontend, unless you surface the two backends via a proxy that handles the routing instead."]})]})}const u=function(e={}){const{wrapper:t}=Object.assign({},(0,r.ah)(),e.components);return t?(0,o.jsx)(t,Object.assign({},e,{children:(0,o.jsx)(d,e)})):d(e)}},862525:e=>{var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var o={};return"abcdefghijklmnopqrst".split("").forEach((function(e){o[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},o)).join("")}catch(r){return!1}}()?Object.assign:function(e,r){for(var i,a,s=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),c=1;c<arguments.length;c++){for(var l in i=Object(arguments[c]))n.call(i,l)&&(s[l]=i[l]);if(t){a=t(i);for(var d=0;d<a.length;d++)o.call(i,a[d])&&(s[a[d]]=i[a[d]])}}return s}},371426:(e,t,n)=>{n(862525);var o=n(827378),r=60103;if(t.Fragment=60107,"function"==typeof Symbol&&Symbol.for){var i=Symbol.for;r=i("react.element"),t.Fragment=i("react.fragment")}var a=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s=Object.prototype.hasOwnProperty,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var o,i={},l=null,d=null;for(o in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)s.call(t,o)&&!c.hasOwnProperty(o)&&(i[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps)void 0===i[o]&&(i[o]=t[o]);return{$$typeof:r,type:e,key:l,ref:d,props:i,_owner:a.current}}t.jsx=l,t.jsxs=l},541535:(e,t,n)=>{var o=n(862525),r=60103,i=60106;t.Fragment=60107,t.StrictMode=60108,t.Profiler=60114;var a=60109,s=60110,c=60112;t.Suspense=60113;var l=60115,d=60116;if("function"==typeof Symbol&&Symbol.for){var u=Symbol.for;r=u("react.element"),i=u("react.portal"),t.Fragment=u("react.fragment"),t.StrictMode=u("react.strict_mode"),t.Profiler=u("react.profiler"),a=u("react.provider"),s=u("react.context"),c=u("react.forward_ref"),t.Suspense=u("react.suspense"),l=u("react.memo"),d=u("react.lazy")}var h="function"==typeof Symbol&&Symbol.iterator;function p(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m={};function g(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||f}function b(){}function y(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||f}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(p(85));this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},b.prototype=g.prototype;var k=y.prototype=new b;k.constructor=y,o(k,g.prototype),k.isPureReactComponent=!0;var v={current:null},x=Object.prototype.hasOwnProperty,w={key:!0,ref:!0,__self:!0,__source:!0};function j(e,t,n){var o,i={},a=null,s=null;if(null!=t)for(o in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(a=""+t.key),t)x.call(t,o)&&!w.hasOwnProperty(o)&&(i[o]=t[o]);var c=arguments.length-2;if(1===c)i.children=n;else if(1<c){for(var l=Array(c),d=0;d<c;d++)l[d]=arguments[d+2];i.children=l}if(e&&e.defaultProps)for(o in c=e.defaultProps)void 0===i[o]&&(i[o]=c[o]);return{$$typeof:r,type:e,key:a,ref:s,props:i,_owner:v.current}}function _(e){return"object"==typeof e&&null!==e&&e.$$typeof===r}var S=/\/+/g;function O(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function C(e,t,n,o,a){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case r:case i:c=!0}}if(c)return a=a(c=e),e=""===o?"."+O(c,0):o,Array.isArray(a)?(n="",null!=e&&(n=e.replace(S,"$&/")+"/"),C(a,t,n,"",(function(e){return e}))):null!=a&&(_(a)&&(a=function(e,t){return{$$typeof:r,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(a,n+(!a.key||c&&c.key===a.key?"":(""+a.key).replace(S,"$&/")+"/")+e)),t.push(a)),1;if(c=0,o=""===o?".":o+":",Array.isArray(e))for(var l=0;l<e.length;l++){var d=o+O(s=e[l],l);c+=C(s,t,n,d,a)}else if(d=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=h&&e[h]||e["@@iterator"])?e:null}(e),"function"==typeof d)for(e=d.call(e),l=0;!(s=e.next()).done;)c+=C(s=s.value,t,n,d=o+O(s,l++),a);else if("object"===s)throw t=""+e,Error(p(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return c}function T(e,t,n){if(null==e)return e;var o=[],r=0;return C(e,o,"","",(function(e){return t.call(n,e,r++)})),o}function E(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var P={current:null};function B(){var e=P.current;if(null===e)throw Error(p(321));return e}var R={ReactCurrentDispatcher:P,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:v,IsSomeRendererActing:{current:!1},assign:o};t.Children={map:T,forEach:function(e,t,n){T(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return T(e,(function(){t++})),t},toArray:function(e){return T(e,(function(e){return e}))||[]},only:function(e){if(!_(e))throw Error(p(143));return e}},t.Component=g,t.PureComponent=y,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=R,t.cloneElement=function(e,t,n){if(null==e)throw Error(p(267,e));var i=o({},e.props),a=e.key,s=e.ref,c=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,c=v.current),void 0!==t.key&&(a=""+t.key),e.type&&e.type.defaultProps)var l=e.type.defaultProps;for(d in t)x.call(t,d)&&!w.hasOwnProperty(d)&&(i[d]=void 0===t[d]&&void 0!==l?l[d]:t[d])}var d=arguments.length-2;if(1===d)i.children=n;else if(1<d){l=Array(d);for(var u=0;u<d;u++)l[u]=arguments[u+2];i.children=l}return{$$typeof:r,type:e.type,key:a,ref:s,props:i,_owner:c}},t.createContext=function(e,t){return void 0===t&&(t=null),(e={$$typeof:s,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=j,t.createFactory=function(e){var t=j.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:c,render:e}},t.isValidElement=_,t.lazy=function(e){return{$$typeof:d,_payload:{_status:-1,_result:e},_init:E}},t.memo=function(e,t){return{$$typeof:l,type:e,compare:void 0===t?null:t}},t.useCallback=function(e,t){return B().useCallback(e,t)},t.useContext=function(e,t){return B().useContext(e,t)},t.useDebugValue=function(){},t.useEffect=function(e,t){return B().useEffect(e,t)},t.useImperativeHandle=function(e,t,n){return B().useImperativeHandle(e,t,n)},t.useLayoutEffect=function(e,t){return B().useLayoutEffect(e,t)},t.useMemo=function(e,t){return B().useMemo(e,t)},t.useReducer=function(e,t,n){return B().useReducer(e,t,n)},t.useRef=function(e){return B().useRef(e)},t.useState=function(e){return B().useState(e)},t.version="17.0.2"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Zo:()=>s,ah:()=>i});var o=n(667294);const r=o.createContext({});function i(e){const t=o.useContext(r);return o.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}const a={};function s({components:e,children:t,disableParentContext:n}){let s;return s=n?"function"==typeof e?e({}):e||a:i(e),o.createElement(r.Provider,{value:s},t)}}}]);