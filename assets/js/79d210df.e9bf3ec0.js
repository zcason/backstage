/*! For license information please see 79d210df.e9bf3ec0.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[507940],{679862:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var r=n(824246),o=n(511151);const i={id:"easy-auth",title:"Azure EasyAuth Provider",sidebar_label:"Azure Easy Auth",description:"Adding Azure's EasyAuth Proxy as an authentication provider in Backstage"},a=void 0,s={unversionedId:"auth/microsoft/easy-auth",id:"auth/microsoft/easy-auth",title:"Azure EasyAuth Provider",description:"Adding Azure's EasyAuth Proxy as an authentication provider in Backstage",source:"@site/../docs/auth/microsoft/azure-easyauth.md",sourceDirName:"auth/microsoft",slug:"/auth/microsoft/easy-auth",permalink:"/docs/auth/microsoft/easy-auth",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/auth/microsoft/azure-easyauth.md",tags:[],version:"current",frontMatter:{id:"easy-auth",title:"Azure EasyAuth Provider",sidebar_label:"Azure Easy Auth",description:"Adding Azure's EasyAuth Proxy as an authentication provider in Backstage"},sidebar:"docs",previous:{title:"Azure",permalink:"/docs/auth/microsoft/provider"},next:{title:"Bitbucket",permalink:"/docs/auth/bitbucket/provider"}},u={},c=[{value:"Backstage Changes",id:"backstage-changes",level:2},{value:"Frontend Changes",id:"frontend-changes",level:2},{value:"Azure Configuration",id:"azure-configuration",level:2},{value:"Azure App Services",id:"azure-app-services",level:3}];function l(e){const t=Object.assign({p:"p",code:"code",h2:"h2",pre:"pre",a:"a",h3:"h3"},(0,o.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["The Backstage ",(0,r.jsx)(t.code,{children:"core-plugin-api"})," package comes with a Microsoft authentication provider that can authenticate users using Azure Active Directory for PaaS service hosted in Azure that support Easy Auth, such as Azure App Services."]}),"\n",(0,r.jsx)(t.h2,{id:"backstage-changes",children:"Backstage Changes"}),"\n",(0,r.jsxs)(t.p,{children:["Add the following into your ",(0,r.jsx)(t.code,{children:"app-config.yaml"})," or ",(0,r.jsx)(t.code,{children:"app-config.production.yaml"})," file"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"auth:\n  environment: development\n  providers:\n    azure-easyauth:\n      development: {}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Add a ",(0,r.jsx)(t.code,{children:"providerFactories"})," entry to the router in\n",(0,r.jsx)(t.code,{children:"packages/backend/src/plugins/auth.ts"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"import { providers } from '@backstage/plugin-auth-backend';\n\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  const authProviderFactories = {\n    'azure-easyauth': providers.easyAuth.create({\n      signIn: {\n        resolver: async (info, ctx) => {\n          const {\n            fullProfile: { id },\n          } = info.result;\n\n          if (!id) {\n            throw new Error('User profile contained no id');\n          }\n\n          return await ctx.signInWithCatalogUser({\n            annotations: {\n              'graph.microsoft.com/user-id': id,\n            },\n          });\n        },\n      },\n    }),\n  };\n\n  return await createRouter({\n    logger: env.logger,\n    config: env.config,\n    database: env.database,\n    discovery: env.discovery,\n    tokenManager: env.tokenManager,\n    providerFactories: authProviderFactories,\n  });\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now the backend is ready to serve auth requests on the\n",(0,r.jsx)(t.code,{children:"/api/auth/azure-easyauth/refresh"})," endpoint. All that's left is to update the frontend\nsign-in mechanism to poll that endpoint through the IAP, on the user's behalf."]}),"\n",(0,r.jsx)(t.h2,{id:"frontend-changes",children:"Frontend Changes"}),"\n",(0,r.jsxs)(t.p,{children:["To use this component, you'll need to configure the app's ",(0,r.jsx)(t.code,{children:"SignInPage"}),".\nIt is recommended to use the ",(0,r.jsx)(t.code,{children:"ProxiedSignInPage"})," for this provider when running in Azure, However for local development (or any other scenario running outside of Azure), you'll want to set up something different.\nFor the closest experience to Easy Auth, you could set up the ",(0,r.jsx)(t.code,{children:"microsoft"})," provider locally, but that will requires setting up App Registrations & secrets which may be locked down by your organisation, in which case it may be easier to use guest login locally.\nSee ",(0,r.jsx)(t.a,{href:"/docs/auth/#sign-in-with-proxy-providers",children:"Sign-In with Proxy Providers"})," for more details."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",metastring:'title="packages/app/src/App.tsx"',children:"/* highlight-add-next-line */\nimport { ProxiedSignInPage } from '@backstage/core-components';\n\nconst app = createApp({\n  /* highlight-add-start */\n  components: {\n    SignInPage: props => {\n      const configApi = useApi(configApiRef);\n      if (configApi.getString('auth.environment') !== 'development') {\n        return <ProxiedSignInPage {...props} provider=\"azure-easyauth\" />;\n      }\n      return (\n        <SignInPage\n          {...props}\n          providers={['guest', 'custom']}\n          title=\"Select a sign-in method\"\n          align=\"center\"\n        />\n      );\n    },\n  },\n  /* highlight-add-end */\n  // ..\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"azure-configuration",children:"Azure Configuration"}),"\n",(0,r.jsx)(t.p,{children:"How to configure azure depends on the service you're enable AAD auth on the app service."}),"\n",(0,r.jsx)(t.h3,{id:"azure-app-services",children:"Azure App Services"}),"\n",(0,r.jsx)(t.p,{children:"To use EasyAuth with App Services, turn on Active Directory authentication\nYou must also enable the token store."}),"\n",(0,r.jsx)(t.p,{children:"The following example shows how to do this via a bicep template:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bicep",children:"resource webApp 'Microsoft.Web/sites@2022-03-01' existing = {\n  name: 'MY-WEBAPP-NAME'\n\n  resource authConfig 'config' = {\n    name: 'authsettingsV2'\n    properties: {\n      globalValidation: {\n        redirectToProvider: 'AzureActiveDirectory'\n        requireAuthentication: true\n        unauthenticatedClientAction: 'RedirectToLoginPage'\n      }\n      login: {\n        tokenStore: {\n          enabled: true\n        }\n      }\n      platform: {\n        enabled: true\n      }\n      identityProviders: {\n        azureActiveDirectory: {\n          enabled: true\n          login: {\n            loginParameters: [ 'domain_hint=MYCOMPANY.COM' ]\n          }\n          registration: {\n            clientId: 'CLIENT-ID'\n            clientSecretSettingName: 'CLIENT-SECRET-NAME'\n            openIdIssuer: 'https://sts.windows.net/${tenant().tenantId}/v2.0'\n          }\n        }\n      }\n    }\n  }\n}\n"})})]})}const p=function(e={}){const{wrapper:t}=Object.assign({},(0,o.ah)(),e.components);return t?(0,r.jsx)(t,Object.assign({},e,{children:(0,r.jsx)(l,e)})):l(e)}},862525:e=>{var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(o){return!1}}()?Object.assign:function(e,o){for(var i,a,s=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),u=1;u<arguments.length;u++){for(var c in i=Object(arguments[u]))n.call(i,c)&&(s[c]=i[c]);if(t){a=t(i);for(var l=0;l<a.length;l++)r.call(i,a[l])&&(s[a[l]]=i[a[l]])}}return s}},371426:(e,t,n)=>{n(862525);var r=n(827378),o=60103;if(t.Fragment=60107,"function"==typeof Symbol&&Symbol.for){var i=Symbol.for;o=i("react.element"),t.Fragment=i("react.fragment")}var a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s=Object.prototype.hasOwnProperty,u={key:!0,ref:!0,__self:!0,__source:!0};function c(e,t,n){var r,i={},c=null,l=null;for(r in void 0!==n&&(c=""+n),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(l=t.ref),t)s.call(t,r)&&!u.hasOwnProperty(r)&&(i[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===i[r]&&(i[r]=t[r]);return{$$typeof:o,type:e,key:c,ref:l,props:i,_owner:a.current}}t.jsx=c,t.jsxs=c},541535:(e,t,n)=>{var r=n(862525),o=60103,i=60106;t.Fragment=60107,t.StrictMode=60108,t.Profiler=60114;var a=60109,s=60110,u=60112;t.Suspense=60113;var c=60115,l=60116;if("function"==typeof Symbol&&Symbol.for){var p=Symbol.for;o=p("react.element"),i=p("react.portal"),t.Fragment=p("react.fragment"),t.StrictMode=p("react.strict_mode"),t.Profiler=p("react.profiler"),a=p("react.provider"),s=p("react.context"),u=p("react.forward_ref"),t.Suspense=p("react.suspense"),c=p("react.memo"),l=p("react.lazy")}var f="function"==typeof Symbol&&Symbol.iterator;function d(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},y={};function g(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||h}function v(){}function m(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||h}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(d(85));this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=g.prototype;var b=m.prototype=new v;b.constructor=m,r(b,g.prototype),b.isPureReactComponent=!0;var A={current:null},j=Object.prototype.hasOwnProperty,x={key:!0,ref:!0,__self:!0,__source:!0};function _(e,t,n){var r,i={},a=null,s=null;if(null!=t)for(r in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(a=""+t.key),t)j.call(t,r)&&!x.hasOwnProperty(r)&&(i[r]=t[r]);var u=arguments.length-2;if(1===u)i.children=n;else if(1<u){for(var c=Array(u),l=0;l<u;l++)c[l]=arguments[l+2];i.children=c}if(e&&e.defaultProps)for(r in u=e.defaultProps)void 0===i[r]&&(i[r]=u[r]);return{$$typeof:o,type:e,key:a,ref:s,props:i,_owner:A.current}}function k(e){return"object"==typeof e&&null!==e&&e.$$typeof===o}var w=/\/+/g;function P(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function S(e,t,n,r,a){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var u=!1;if(null===e)u=!0;else switch(s){case"string":case"number":u=!0;break;case"object":switch(e.$$typeof){case o:case i:u=!0}}if(u)return a=a(u=e),e=""===r?"."+P(u,0):r,Array.isArray(a)?(n="",null!=e&&(n=e.replace(w,"$&/")+"/"),S(a,t,n,"",(function(e){return e}))):null!=a&&(k(a)&&(a=function(e,t){return{$$typeof:o,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(a,n+(!a.key||u&&u.key===a.key?"":(""+a.key).replace(w,"$&/")+"/")+e)),t.push(a)),1;if(u=0,r=""===r?".":r+":",Array.isArray(e))for(var c=0;c<e.length;c++){var l=r+P(s=e[c],c);u+=S(s,t,n,l,a)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),c=0;!(s=e.next()).done;)u+=S(s=s.value,t,n,l=r+P(s,c++),a);else if("object"===s)throw t=""+e,Error(d(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return u}function E(e,t,n){if(null==e)return e;var r=[],o=0;return S(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function C(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var O={current:null};function z(){var e=O.current;if(null===e)throw Error(d(321));return e}var I={ReactCurrentDispatcher:O,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:A,IsSomeRendererActing:{current:!1},assign:r};t.Children={map:E,forEach:function(e,t,n){E(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return E(e,(function(){t++})),t},toArray:function(e){return E(e,(function(e){return e}))||[]},only:function(e){if(!k(e))throw Error(d(143));return e}},t.Component=g,t.PureComponent=m,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=I,t.cloneElement=function(e,t,n){if(null==e)throw Error(d(267,e));var i=r({},e.props),a=e.key,s=e.ref,u=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,u=A.current),void 0!==t.key&&(a=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)j.call(t,l)&&!x.hasOwnProperty(l)&&(i[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)i.children=n;else if(1<l){c=Array(l);for(var p=0;p<l;p++)c[p]=arguments[p+2];i.children=c}return{$$typeof:o,type:e.type,key:a,ref:s,props:i,_owner:u}},t.createContext=function(e,t){return void 0===t&&(t=null),(e={$$typeof:s,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=_,t.createFactory=function(e){var t=_.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:u,render:e}},t.isValidElement=k,t.lazy=function(e){return{$$typeof:l,_payload:{_status:-1,_result:e},_init:C}},t.memo=function(e,t){return{$$typeof:c,type:e,compare:void 0===t?null:t}},t.useCallback=function(e,t){return z().useCallback(e,t)},t.useContext=function(e,t){return z().useContext(e,t)},t.useDebugValue=function(){},t.useEffect=function(e,t){return z().useEffect(e,t)},t.useImperativeHandle=function(e,t,n){return z().useImperativeHandle(e,t,n)},t.useLayoutEffect=function(e,t){return z().useLayoutEffect(e,t)},t.useMemo=function(e,t){return z().useMemo(e,t)},t.useReducer=function(e,t,n){return z().useReducer(e,t,n)},t.useRef=function(e){return z().useRef(e)},t.useState=function(e){return z().useState(e)},t.version="17.0.2"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Zo:()=>s,ah:()=>i});var r=n(667294);const o=r.createContext({});function i(e){const t=r.useContext(o);return r.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}const a={};function s({components:e,children:t,disableParentContext:n}){let s;return s=n?"function"==typeof e?e({}):e||a:i(e),r.createElement(o.Provider,{value:s},t)}}}]);